import{b as Ne}from"./vue-router-38a26824.js";import{x as F}from"./axios-0b03b3f1.js";import{e as pe}from"./index-a67b3544.js";import{q as Y,r as f,p as le,t as ve,o as j,A as ke,m as ue,B as E,C as re,D as he,n as ge,a as G,E as Ve,F as $e,d as fe,x as ze,v as Pe,G as Ie,H as Te,w as qe}from"./vuetify-41d014fb.js";import{b5 as Re,f as u,aG as Ce,ay as De,w as xe,aP as Fe,o as S,J as be,bs as a,X as e,W as w,u as k,b1 as I,i as Oe,a as i,L as Me,c as te,F as me,aO as we,aI as Se,aF as Le,I as Be,bx as je}from"./@vue-00b20f2b.js";import{_ as Ge}from"./@fawmi-f1769799.js";import"./@iconify-452d8fcb.js";import"./mitt-f7ef348c.js";import"./@supabase-9ce37a4a.js";import"./pinia-b2002cd0.js";import"./@googlemaps-b4d342ab.js";import"./fast-deep-equal-099ec698.js";import"./apexcharts-clevision-d64c90db.js";import"./supercluster-6504d485.js";import"./kdbush-ac640998.js";const He=i("form",{class:"d-flex flex-column gap-5"},[i("p",{class:"text-body-1 mb-0"}," Editar de la Tarea ")],-1),We=i("form",{class:"d-flex flex-column gap-5"},[i("p",{class:"text-body-1 mb-0"}," Editar cuadrilla Asignada ")],-1),Je={__name:"EditTareaForm",props:{isOpen:{type:Boolean,required:!0},task:{type:Object,required:!0}},emits:["update:isOpen","save"],setup(H,{emit:$}){const O=H,{isOpen:c,task:r}=Re(O),C=()=>{$("update:isOpen",!1)},d=u({}),v=u([]),K=["Obra negra","Obra gris","Obra blanca"],L=["Retirada","Asignada","En desarrollo","En revision","Aceptada"],W=u([]),se=u([]),q=u([]),Z=u([]),ee=u([]),ae=u([]),b=u({}),T=u({}),_=u({}),R=u({});Ce(d);const m=u(""),s=V=>{m.value=V,window.clearTimeout(p),document.getElementById("error").scrollIntoView();var p=setTimeout(()=>{m.value=""},5e3)},o=async V=>(await F.get(`http://desarrollo-constructora-back.onrender.com/constructora/v1/${V}/`)).data,x=V=>["nombres","apellidos"].map(J=>V[J]).filter(Boolean).join(" "),h=async()=>{try{const[V,p,J]=await Promise.all([o("DirectorDeObra"),o("Director_Obra"),o("Usuario")]);if(V.length===0)throw new Error("No se encontraron directores de obra");const y={};p.forEach(B=>{const X=V.find(g=>g.directorid===B.directorid);if(X){const g=J.find(ne=>ne.numerodeid===X.numerodeid);if(g){const ne=x(g);y[B.obraid]||(y[B.obraid]=[]),y[B.obraid].includes(ne)||y[B.obraid].push(ne)}}}),d.value=y,console.log("Directors:",d.value)}catch(V){console.error("Error al obtener el director para la obra:",V)}},z=async V=>{try{const[p,J,y,B]=await Promise.all([o("Capataz"),o("Peon"),o("AyudanteDeObra"),o("Usuario")]),X=await o(`Usuario_Obra/${V}/get-by-obraid`);B.forEach(D=>{R.value[`${D.nombres} ${D.apellidos}`]=D.numerodeid});const g=X.filter(D=>p.some(t=>t.numerodeid===D.numerodeid)).map(D=>{const t=B.find(l=>l.numerodeid===D.numerodeid);return b.value[`${t.nombres} ${t.apellidos}`]=p.find(l=>l.numerodeid===D.numerodeid).capatazid,`${t.nombres} ${t.apellidos}`}),ne=X.filter(D=>J.some(t=>t.numerodeid===D.numerodeid)).map(D=>{const t=B.find(l=>l.numerodeid===D.numerodeid);return T.value[`${t.nombres} ${t.apellidos}`]=J.find(l=>l.numerodeid===D.numerodeid).peonid,`${t.nombres} ${t.apellidos}`}),_e=X.filter(D=>y.some(t=>t.numerodeid===D.numerodeid)).map(D=>{const t=B.find(l=>l.numerodeid===D.numerodeid);return _.value[`${t.nombres} ${t.apellidos}`]=y.find(l=>l.numerodeid===D.numerodeid).ayudanteid,`${t.nombres} ${t.apellidos}`});W.value=g,se.value=ne,q.value=_e,Z.value=[...r.value.capataz],ee.value=[...r.value.peon],ae.value=[...r.value.ayudante],console.log("Capataces:",W.value),console.log("Peones:",se.value),console.log("Ayudantes:",q.value)}catch(p){console.error("Error al obtener roles de obra:",p)}},U=async()=>{if(r.value.descripcion=="")console.log("wtf"),s("Debe darle un descripcion a la tarea");else if(r.value.capataz.length==0)s("Debe seleccionar al menos un capataz");else if(r.value.peon.length==0)s("Debe seleccionar al menos un peon");else if(r.value.ayudante.length==0)s("Debe seleccionar al menos un ayudante");else try{await F.put(`http://desarrollo-constructora-back.onrender.com/constructora/v1/Tarea/${r.value.tareaid}/`,{obraid:r.value.obraid,tipodetarea:r.value.tipodetarea,descripcion:r.value.descripcion,fechaasignacion:r.value.fechaasignacion,fechaestimada:r.value.fechaestimada,fechaestimada:r.value.fechaestimada,estado:r.value.estado});const V=r.value.capataz.filter(g=>!Z.value.includes(g)).map(g=>b.value[g]),p=Z.value.filter(g=>!r.value.capataz.includes(g)).map(g=>b.value[g]);await F.patch(`http://desarrollo-constructora-back.onrender.com/constructora/v1/Capataz_Tarea/${r.value.tareaid}/modify-capataz-by-tareaid/`,{add_capataces:V,remove_capataces:p});const J=r.value.peon.filter(g=>!ee.value.includes(g)).map(g=>T.value[g]),y=ee.value.filter(g=>!r.value.peon.includes(g)).map(g=>T.value[g]);try{await F.patch(`http://desarrollo-constructora-back.onrender.com/constructora/v1/Peon_Tarea/${r.value.tareaid}/modify-peones-by-tareaid/`,{add_peones:J,remove_peones:y}),console.log("Peones a agregar:",J),console.log("Peones a remover :",y),console.log("Peones actualizados con éxito")}catch(g){console.error("Error al actualizar peones:",g)}const B=r.value.ayudante.filter(g=>!ae.value.includes(g)).map(g=>_.value[g]),X=ae.value.filter(g=>!r.value.ayudante.includes(g)).map(g=>_.value[g]);try{await F.patch(`http://desarrollo-constructora-back.onrender.com/constructora/v1/AyudanteDeObra_Tarea/${r.value.tareaid}/modify-ayudantes-by-tareaid/`,{add_ayudantes:B,remove_ayudantes:X}),console.log("Ayudantes a agregar:",B),console.log("Ayudantes a remover :",X),console.log("Ayudantes actualizados con éxito")}catch(g){console.error("Error al actualizar ayudantes:",g)}$("save",r.value),C()}catch(V){console.error("Error al guardar la tarea:",V)}};De(()=>{r.value.obraid&&z(r.value.obraid),h()}),xe(()=>r.value.obraid,V=>{V&&z(V)});const M=()=>{r.value={}};return(V,p)=>{const J=Fe("VcardText");return S(),be(Ve,{modelValue:k(c),"onUpdate:modelValue":p[12]||(p[12]=y=>Oe(c)?c.value=y:null)},{default:a(()=>[e(Y,{justify:"center"},{default:a(()=>[e(f,{cols:"12",md:"8"},{default:a(()=>[e(le,null,{default:a(()=>[e(ve,null,{default:a(()=>[w(" Editar Tarea ")]),_:1}),e(j,null,{default:a(()=>[e(ke,{ref:"form",class:"mt-6"},{default:a(()=>[e(Y,null,{default:a(()=>[e(ue),e(f,{cols:"12",md:"3"},{default:a(()=>[e(E,{modelValue:k(r).tareaid,"onUpdate:modelValue":p[0]||(p[0]=y=>k(r).tareaid=y),label:"ID de la Tarea",readonly:"",style:{backgroundColor:"#f0f0f0",pointerEvents:"none"}},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"3"},{default:a(()=>[e(E,{modelValue:k(r).obraid,"onUpdate:modelValue":p[1]||(p[1]=y=>k(r).obraid=y),label:"ID de la Obra",required:"",readonly:"",items:v.value,class:"mb-3",style:{backgroundColor:"#f0f0f0",pointerEvents:"none"}},null,8,["modelValue","items"])]),_:1}),e(f,{cols:"12",md:"3"},{default:a(()=>[e(E,{modelValue:k(r).nombreobra,"onUpdate:modelValue":p[2]||(p[2]=y=>k(r).nombreobra=y),label:"Nombre de la obra",required:"",readonly:"",style:{backgroundColor:"#f0f0f0",pointerEvents:"none"},class:"mb-3"},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"3"},{default:a(()=>[e(E,{modelValue:k(r).director,"onUpdate:modelValue":p[3]||(p[3]=y=>k(r).director=y),label:"Director de la obra",required:"",readonly:"",style:{backgroundColor:"#f0f0f0",pointerEvents:"none"},class:"mb-3"},null,8,["modelValue"])]),_:1}),e(ue),e(j,null,{default:a(()=>[He]),_:1}),e(f,{cols:"12",md:"9"},{default:a(()=>[e(E,{modelValue:k(r).descripcion,"onUpdate:modelValue":p[4]||(p[4]=y=>k(r).descripcion=y),label:"Descripcion de Tarea",required:"",type:"text",class:"mb-3"},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"3"},{default:a(()=>[e(re,{modelValue:k(r).tipodetarea,"onUpdate:modelValue":p[5]||(p[5]=y=>k(r).tipodetarea=y),label:"Tipo de Tarea",required:"",items:K,class:"mb-3"},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"3"},{default:a(()=>[e(E,{modelValue:k(r).fechaasignacion,"onUpdate:modelValue":p[6]||(p[6]=y=>k(r).fechaasignacion=y),label:"Fecha Estimada",required:"",type:"date",class:"mb-3"},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"3"},{default:a(()=>[e(E,{modelValue:k(r).fechaestimada,"onUpdate:modelValue":p[7]||(p[7]=y=>k(r).fechaestimada=y),label:"Fecha Estimada",required:"",type:"date",class:"mb-3"},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"3"},{default:a(()=>[e(re,{modelValue:k(r).estado,"onUpdate:modelValue":p[8]||(p[8]=y=>k(r).estado=y),label:"Estado",required:"",items:L,class:"mb-3"},null,8,["modelValue"])]),_:1}),e(ue),e(j,null,{default:a(()=>[We]),_:1}),e(ue),e(f,{class:"cuadrilla-list"},{default:a(()=>[e(f,null,{default:a(()=>[e(Y,{justify:"center"},{default:a(()=>[e(f,{cols:"12",md:"4"},{default:a(()=>[e(re,{modelValue:k(r).capataz,"onUpdate:modelValue":p[9]||(p[9]=y=>k(r).capataz=y),label:"Capataz",items:W.value,multiple:"","menu-props":{maxHeight:500}},null,8,["modelValue","items"])]),_:1}),e(f,{cols:"12",md:"4"},{default:a(()=>[e(re,{modelValue:k(r).peon,"onUpdate:modelValue":p[10]||(p[10]=y=>k(r).peon=y),label:"Peones",items:se.value,multiple:"","menu-props":{maxHeight:500}},null,8,["modelValue","items"])]),_:1}),e(f,{cols:"12",md:"4"},{default:a(()=>[e(re,{modelValue:k(r).ayudante,"onUpdate:modelValue":p[11]||(p[11]=y=>k(r).ayudante=y),label:"Ayudantes",items:q.value,multiple:"","menu-props":{maxHeight:500}},null,8,["modelValue","items"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},512)]),_:1}),e(he,null,{default:a(()=>[e(J,{style:{color:"darkred"}},{default:a(()=>[w(I(m.value),1)]),_:1}),e(ge),e(G,{color:"blue darken-1",text:"",class:"mt-4",onClick:M},{default:a(()=>[w(" Resetear ")]),_:1}),e(G,{color:"red",text:"",class:"mt-4",onClick:C},{default:a(()=>[w(" Cancelar ")]),_:1}),e(G,{color:"primary",text:"",class:"mt-4",onClick:U},{default:a(()=>[w(" Guardar ")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])}}},Ee={__name:"ShowDetailsTareasForm",props:{task:{type:Object,required:!0},archivedTask:{type:Object,required:!1},isOpen:{type:Boolean,required:!0}},emits:["update:isOpen"],setup(H,{emit:$}){const O=H,c=u({});u([]),xe(()=>O.isOpen,C=>{C&&(O.archivedTask?c.value={...O.archivedTask}:c.value={...O.task})},{immediate:!0});const r=()=>{$("update:isOpen",!1)};return(C,d)=>(S(),be(Ve,{"model-value":H.isOpen,"onUpdate::modelValue":r},{default:a(()=>[e(Y,{justify:"center"},{default:a(()=>[e(f,{cols:"12",md:"8"},{default:a(()=>[e(le,null,{default:a(()=>[e(ve,{class:"headline"},{default:a(()=>[w(" Detalles de la Obra ")]),_:1}),e(j,null,{default:a(()=>[c.value?(S(),be(ke,{key:0},{default:a(()=>[e(Y,null,{default:a(()=>[e(f,{cols:"12",md:"6"},{default:a(()=>[e(E,{modelValue:c.value.tareaid,"onUpdate:modelValue":d[0]||(d[0]=v=>c.value.tareaid=v),label:"ID de la tarea",readonly:""},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(E,{modelValue:c.value.obraid,"onUpdate:modelValue":d[1]||(d[1]=v=>c.value.obraid=v),label:"Id de la Obra",readonly:""},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(E,{modelValue:c.value.nombreobra,"onUpdate:modelValue":d[2]||(d[2]=v=>c.value.nombreobra=v),label:"Id de la Obra",readonly:""},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(E,{modelValue:c.value.tipodetarea,"onUpdate:modelValue":d[3]||(d[3]=v=>c.value.tipodetarea=v),label:"Tipo de Tarea ",readonly:""},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(E,{modelValue:c.value.descripcion,"onUpdate:modelValue":d[4]||(d[4]=v=>c.value.descripcion=v),label:"Descripcion de la tarea",readonly:""},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(E,{modelValue:c.value.fechaasignacion,"onUpdate:modelValue":d[5]||(d[5]=v=>c.value.fechaasignacion=v),label:"Fecha de asignación",readonly:""},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(E,{modelValue:c.value.fechaestimada,"onUpdate:modelValue":d[6]||(d[6]=v=>c.value.fechaestimada=v),label:"Fecha de asignación",readonly:""},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(E,{modelValue:c.value.estado,"onUpdate:modelValue":d[7]||(d[7]=v=>c.value.estado=v),label:"Estado de la tarea",readonly:""},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(E,{modelValue:c.value.director,"onUpdate:modelValue":d[8]||(d[8]=v=>c.value.director=v),label:"Director a cargo",readonly:""},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(E,{modelValue:c.value.capataz,"onUpdate:modelValue":d[9]||(d[9]=v=>c.value.capataz=v),label:"Capataces asignados",readonly:""},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(E,{modelValue:c.value.peon,"onUpdate:modelValue":d[10]||(d[10]=v=>c.value.peon=v),label:"Peones asignados",readonly:""},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(E,{modelValue:c.value.ayudante,"onUpdate:modelValue":d[11]||(d[11]=v=>c.value.ayudante=v),label:"Ayudantes asignados",readonly:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})):Me("",!0)]),_:1}),e(he,null,{default:a(()=>[e(ge),e(G,{color:"blue darken-1",onClick:r},{default:a(()=>[w(" Cerrar ")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model-value"]))}},Xe=i("thead",null,[i("tr",null,[i("th",{class:"text-uppercase"},"Obraid"),i("th",{class:"text-uppercase"},"Tareaid"),i("th",null,"Tipo de tarea"),i("th",null,"Fecha asignacion"),i("th",null,"Fecha estimada"),i("th",null,"Estado"),i("th",null,"Activo"),i("th",null,"Director"),i("th",null,"Detalle")])],-1),Ke={class:"text-center"},Qe={class:"text-center"},Ye={class:"text-center"},Ze={class:"text-center"},ea={class:"text-center"},aa={class:"text-center"},oa={class:"text-center"},ra={__name:"EditableTareasList",setup(H){const $=u({});u({}),u({}),u({});const O=u({}),c=u(!1),r=u(!1);u(!1);const C=u(!1),d=u([]),v=u({}),K=u({}),L=async m=>(await F.get(`http://desarrollo-constructora-back.onrender.com/constructora/v1/${m}/`)).data,W=m=>["nombres","apellidos"].map(o=>m[o]).filter(Boolean).join(" "),se=async()=>{try{const[m,s,o]=await Promise.all([L("DirectorDeObra"),L("Director_Obra"),L("Usuario")]);if(m.length===0)throw new Error("No se encontraron directores de obra");const x={};s.forEach(h=>{const z=m.find(U=>U.directorid===h.directorid);if(z){const U=o.find(M=>M.numerodeid===z.numerodeid);if(U){const M=W(U);x[h.obraid]||(x[h.obraid]=[]),x[h.obraid].includes(M)||x[h.obraid].push(M)}}}),$.value=x,console.log("Directors:",$.value)}catch(m){console.error("Error al obtener el director para la obra:",m)}},q=async(m,s)=>{try{const[o,x,h]=await Promise.all([L(m+"_Tarea"),L(m),L("Usuario")]),z={};return o.forEach(U=>{const M=x.find(V=>V[s]===U[s]);if(M){const V=h.find(p=>p.numerodeid===M.numerodeid);if(V){const p=W(V);z[U.tareaid]||(z[U.tareaid]=[]),z[U.tareaid].includes(p)||z[U.tareaid].push(p)}}}),z}catch(o){return console.error(`Error al obtener roles para ${m}:`,o),{}}},Z=async()=>{try{const m=await L("Obra"),s={};m.forEach(o=>{s[o.obraid]=o.nombre}),O.value=s,console.log("ObraNombres:",O.value)}catch(m){console.error("Error al obtener los nombres de las obras:",m)}},ee=async()=>{try{const m=await L("Tarea");await se(),await Z();const[s,o,x]=await Promise.all([q("Capataz","capatazid"),q("Peon","peonid"),q("AyudanteDeObra","ayudanteid")]);d.value=m.filter(h=>h.activo).map(h=>({obraid:h.obraid,tareaid:h.tareaid,tipodetarea:h.tipodetarea,descripcion:h.descripcion,fechaasignacion:h.fechaasignacion,fechaestimada:h.fechaestimada,estado:h.estado,activo:h.activo,nombreobra:O.value[h.obraid]||"Sin Nombre de Obra",director:$.value[h.obraid]?$.value[h.obraid].join(", "):"Sin Director asignado",capataz:s[h.tareaid]||[],peon:o[h.tareaid]||[],ayudante:x[h.tareaid]||[]})),console.log("Tasks:",d.value)}catch(m){console.error("Error al obtener las tareas:",m)}};De(()=>{ee(),pe.on("tareas",ee),pe.on("tarea-create",ee)});const ae=m=>{K.value={...m},C.value=!0},b=m=>{K.value={...m},c.value=!0},T=m=>{v.value={...m},r.value=!0},_=m=>{const s=d.value.findIndex(o=>o.tareaid===m.tareaid);s!==-1&&(d.value[s]={...m})},R=async m=>{try{const s=K.value;console.log("Datos que se enviarán al servidor:",s);const o=await F.put(`http://desarrollo-constructora-back.onrender.com/constructora/v1/Tarea/${s.tareaid}/`,{...s,activo:!1});d.value=d.value.filter(x=>x.tareaid!==s.tareaid),console.log(`Tarea ${s.tareaid} archivada con éxito`),pe.emit("tarea-archived")}catch(s){console.error("Error al archivar el usuario:",s)}finally{c.value=!1}};return(m,s)=>(S(),te(me,null,[e(Y,null,{default:a(()=>[e(f,{cols:"12"},{default:a(()=>[e(le,null,{default:a(()=>[e(ve,null,{default:a(()=>[w(" Lista de Tareas ")]),_:1}),e(j,null,{default:a(()=>[e($e,null,{default:a(()=>[Xe,i("tbody",null,[(S(!0),te(me,null,we(d.value,o=>(S(),te("tr",{key:o.tareaid},[i("td",null,I(o.obraid),1),i("td",null,I(o.tareaid),1),i("td",Ke,I(o.tipodetarea),1),i("td",Qe,I(o.fechaasignacion),1),i("td",Ye,I(o.fechaestimada),1),i("td",Ze,I(o.estado),1),i("td",ea,I(o.activo?"Sí":"No"),1),i("td",aa,I(o.director),1),i("td",oa,[e(G,{icon:"",style:{marginLeft:"0.5rem"},onClick:x=>ae(o)},{default:a(()=>[e(fe,null,{default:a(()=>[w("mdi-eye")]),_:1})]),_:2},1032,["onClick"]),e(G,{icon:"",style:{marginLeft:"0.5rem",marginRight:"0.5rem"},onClick:x=>T(o)},{default:a(()=>[e(fe,null,{default:a(()=>[w("mdi-pencil")]),_:1})]),_:2},1032,["onClick"]),e(G,{icon:"",style:{marginLeft:"0.5rem"},onClick:x=>b(o)},{default:a(()=>[e(fe,null,{default:a(()=>[w("mdi-archive")]),_:1})]),_:2},1032,["onClick"])])]))),128))])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(Je,{isOpen:r.value,"onUpdate:isOpen":s[0]||(s[0]=o=>r.value=o),task:v.value,onSave:_},null,8,["isOpen","task"]),e(Ee,{isOpen:C.value,"onUpdate:isOpen":s[1]||(s[1]=o=>C.value=o),task:K.value},null,8,["isOpen","task"]),e(Ve,{modelValue:c.value,"onUpdate:modelValue":s[3]||(s[3]=o=>c.value=o),"max-width":"500px"},{default:a(()=>[e(le,null,{default:a(()=>[e(ve,{class:"headline"},{default:a(()=>[w(" Confirmar Archivo ")]),_:1}),e(j,null,{default:a(()=>[w(" ¿Estás seguro de que deseas archivar esta? ")]),_:1}),e(he,null,{default:a(()=>[e(ge),e(G,{color:"blue darken-1",text:"",onClick:s[2]||(s[2]=o=>c.value=!1)},{default:a(()=>[w(" Cancelar ")]),_:1}),e(G,{color:"blue darken-1",text:"",onClick:R},{default:a(()=>[w(" Confirmar ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}},ta=i("code",null,"Tareas Activas",-1),la={__name:"TareasList",setup(H){return($,O)=>(S(),be(Y,null,{default:a(()=>[e(f,{cols:"12"},{default:a(()=>[e(le,{title:"Tareas"},{default:a(()=>[e(j,null,{default:a(()=>[ta]),_:1}),e(ra)]),_:1})]),_:1})]),_:1}))}};const sa=H=>(Se("data-v-3540728f"),H=H(),Le(),H),na=sa(()=>i("thead",null,[i("tr",null,[i("th",{class:"text-uppercase"}," Obraid "),i("th",{class:"text-uppercase"}," Tareaid "),i("th",null,"Tipo de tarea"),i("th",null,"Fecha asignacion"),i("th",null,"Fecha estimada"),i("th",null,"Estado"),i("th",null,"Director"),i("th",null,"Acciones")])],-1)),da={class:"text-center"},ua={class:"text-center"},ia={class:"text-center"},ca={class:"text-center"},ma={class:"text-center"},pa={class:"text-center action-buttons"},fa={__name:"EditableArchivedTareasList",setup(H){const $=u({});u({}),u({}),u({});const O=u({}),c=u([]),r=u({}),C=u(!1),d=u(!1);Ce($);const v=async b=>(await F.get(`http://desarrollo-constructora-back.onrender.com/constructora/v1/${b}/`)).data,K=b=>["nombres","apellidos"].map(_=>b[_]).filter(Boolean).join(" "),L=async()=>{try{const[b,T,_]=await Promise.all([v("DirectorDeObra"),v("Director_Obra"),v("Usuario")]);if(b.length===0)throw new Error("No se encontraron directores de obra");const R={};T.forEach(m=>{const s=b.find(o=>o.directorid===m.directorid);if(s){const o=_.find(x=>x.numerodeid===s.numerodeid);if(o){const x=K(o);R[m.obraid]||(R[m.obraid]=[]),R[m.obraid].includes(x)||R[m.obraid].push(x)}}}),$.value=R,console.log("Directors:",$.value)}catch(b){console.error("Error al obtener el director para la obra:",b)}},W=async(b,T)=>{try{const[_,R,m]=await Promise.all([v(b+"_Tarea"),v(b),v("Usuario")]),s={};return _.forEach(o=>{const x=R.find(h=>h[T]===o[T]);if(x){const h=m.find(z=>z.numerodeid===x.numerodeid);if(h){const z=K(h);s[o.tareaid]||(s[o.tareaid]=[]),s[o.tareaid].includes(z)||s[o.tareaid].push(z)}}}),s}catch(_){return console.error(`Error al obtener roles para ${b}:`,_),{}}},se=async()=>{try{const b=await v("Obra"),T={};b.forEach(_=>{T[_.obraid]=_.nombre}),O.value=T,console.log("ObraNombres:",O.value)}catch(b){console.error("Error al obtener los nombres de las obras:",b)}},q=async()=>{try{const b=await v("Tarea");await L(),await se();const[T,_,R]=await Promise.all([W("Capataz","capatazid"),W("Peon","peonid"),W("AyudanteDeObra","ayudanteid")]),m=b.filter(s=>!s.activo).map(s=>({obraid:s.obraid,tareaid:s.tareaid,tipodetarea:s.tipodetarea,descripcion:s.descripcion,fechaasignacion:s.fechaasignacion,fechaestimada:s.fechaestimada,estado:s.estado,activo:s.activo,nombreobra:O.value[s.obraid]||"Sin Nombre de Obra",director:$.value[s.obraid]?$.value[s.obraid].join(", "):"Sin Director asignado",capataz:T[s.tareaid]||[],peon:_[s.tareaid]||[],ayudante:R[s.tareaid]||[]}));c.value=m,console.log("Archived Tasks:",c.value)}catch(b){console.error("Error al obtener las tareas archivadas:",b)}},Z=b=>{r.value={...b},d.value=!0},ee=b=>{r.value={...b},C.value=!0},ae=async()=>{try{const b=r.value;await F.put(`http://desarrollo-constructora-back.onrender.com/constructora/v1/Tarea/${b.tareaid}/`,{...b,activo:!0}),c.value=c.value.filter(T=>T.tareaid!==b.tareaid),console.log(`Tarea ${b.descripcion} restaurada con éxito`),pe.emit("tareas")}catch(b){console.error("Error al restaurar la tarea:",b)}finally{C.value=!1}};return De(()=>{q()}),pe.on("tarea-archived",q),(b,T)=>(S(),te(me,null,[e(Y,null,{default:a(()=>[e(f,{cols:"12"},{default:a(()=>[e(le,null,{default:a(()=>[e(ve,null,{default:a(()=>[w(" Lista de Tareas Archivadas ")]),_:1}),e(j,null,{default:a(()=>[e($e,null,{default:a(()=>[na,i("tbody",null,[(S(!0),te(me,null,we(c.value,_=>(S(),te("tr",{key:_.tareaid},[i("td",null,I(_.obraid),1),i("td",null,I(_.tareaid),1),i("td",da,I(_.tipodetarea),1),i("td",ua,I(_.fechaasignacion),1),i("td",ia,I(_.fechaestimada),1),i("td",ca,I(_.estado),1),i("td",ma,I(_.director),1),i("td",pa,[e(G,{icon:"",style:{marginLeft:"0.3rem"},onClick:R=>Z(_)},{default:a(()=>[e(fe,null,{default:a(()=>[w("mdi-eye")]),_:1})]),_:2},1032,["onClick"]),e(G,{icon:"",style:{marginLeft:"0.3rem"},onClick:R=>ee(_)},{default:a(()=>[e(fe,null,{default:a(()=>[w("mdi-restore")]),_:1})]),_:2},1032,["onClick"])])]))),128))])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(Ee,{isOpen:d.value,"onUpdate:isOpen":T[0]||(T[0]=_=>d.value=_),task:r.value},null,8,["isOpen","task"]),e(Ve,{modelValue:C.value,"onUpdate:modelValue":T[2]||(T[2]=_=>C.value=_),"max-width":"500px"},{default:a(()=>[e(le,null,{default:a(()=>[e(ve,{class:"headline"},{default:a(()=>[w(" Confirmar Restauración ")]),_:1}),e(j,null,{default:a(()=>[w(" ¿Estás seguro de que deseas restaurar esta tarea? ")]),_:1}),e(he,null,{default:a(()=>[e(ge),e(G,{color:"blue darken-1",text:"",onClick:T[1]||(T[1]=_=>C.value=!1)},{default:a(()=>[w(" Cancelar ")]),_:1}),e(G,{color:"blue darken-1",text:"",onClick:ae},{default:a(()=>[w(" Confirmar ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}},va=Ge(fa,[["__scopeId","data-v-3540728f"]]),ba=i("code",null,"Tareas archivadas",-1),ya={__name:"TareasArchived",setup(H){return($,O)=>(S(),be(Y,null,{default:a(()=>[e(f,{cols:"12"},{default:a(()=>[e(le,{title:"Tareas Archivadas"},{default:a(()=>[e(j,null,{default:a(()=>[ba]),_:1}),e(va)]),_:1})]),_:1})]),_:1}))}},_a={class:"d-flex flex-column gap-5"},ha={class:"text-body-1 mb-0",style:{color:"darkred"}},ga=i("p",{class:"text-body-1 mb-0"}," Completa los siguientes campos para añadir una tarea a la obra ",-1),Va=i("p",{class:"text-body-1 mb-0"}," Director encargado de la obra: ",-1),Da=i("p",{class:"text-body-1 mb-0"}," Cuadrilla asignada para la tarea ",-1),Ta={__name:"TareasCreate",setup(H){const $=u([]),O=u({}),c=u({}),r=u({}),C=u({}),d=u({}),v=u({}),K=u({}),L=u({}),W=u({}),se=["Obra negra","Obra gris","Obra blanca"],q=async t=>(await F.get(`http://desarrollo-constructora-back.onrender.com/constructora/v1/${t}/`)).data,Z=t=>["nombres","apellidos"].map(n=>t[n]).filter(Boolean).join(" "),ee=async()=>{try{const[t,l,n]=await Promise.all([q("DirectorDeObra"),q("Director_Obra"),q("Usuario")]);if(t.length===0)throw new Error("No se encontraron directores de obra");const A={};l.forEach(N=>{const de=t.find(P=>P.directorid===N.directorid);if(de){const P=n.find(Q=>Q.numerodeid===de.numerodeid);if(P){const Q=Z(P);A[N.obraid]=Q,v.value[Q]=P.numerodeid}}}),O.value=A,A.value=v,console.log("Directors:",O.value),console.log("directorMap:",v.value)}catch(t){console.error("Error al obtener el director para la obra:",t)}},ae=async(t,l,n)=>{try{const[A,N,de]=await Promise.all([q(t),q("Usuario_Obra"),q("Usuario")]);if(A.length===0)throw new Error(`No se encontraron roles para ${t}`);const P={},Q={};N.forEach(oe=>{const ye=A.find(ce=>ce.numerodeid===oe.numerodeid);if(ye){const ce=de.find(ie=>ie.numerodeid===ye.numerodeid);if(ce){const ie=Z(ce);P[oe.obraid]||(P[oe.obraid]=[]),P[oe.obraid].includes(ie)||P[oe.obraid].push(ie),Q[ie]=ce.numerodeid}}}),l.value=P,n.value=Q,console.log(`${t}:`,l.value)}catch(A){console.error(`Error al obtener roles para ${t}:`,A)}},b=async()=>{await ae("Capataz",c,K)},T=async()=>{await ae("Peon",r,L)},_=async()=>{await ae("AyudanteDeObra",C,W)},R=async()=>{try{const l=(await F.get("http://desarrollo-constructora-back.onrender.com/constructora/v1/Obra/")).data;$.value=l.filter(n=>n.activo).map(n=>{const A=`${n.obraid} - ${n.nombre}`;return d.value[A]=n.obraid,{obraid:n.obraid,nombre:n.nombre,tipodeobra:n.tipodeobra,estado:n.estado,displayText:A}}),console.log("Obras:",$.value),console.log("obraIdMap:",d.value)}catch(t){console.error("Error al obtener las obras:",t)}},m=Be(()=>$.value.map(t=>t.displayText)),s={obraid:"Selecciona Obra",tipodetarea:"",estado:"",fechaestimada:"",activo:!0,director:[],capataz:[],peon:[],ayudante:[]},o=u(structuredClone(s)),x=u(null),h=u(!1),z=["Retirada","Asignada","En desarrollo","En revision","Aceptada"],U=u([]),M=u([]),V=u([]),p=async t=>{try{const l=d.value[t];l?(o.value.director=O.value[l]||"Sin Director asignado",o.value.capataz=[],o.value.peon=[],o.value.ayudante=[],U.value=c.value[l]||[],M.value=r.value[l]||[],V.value=C.value[l]||[]):(o.value.director="Sin Director asignado",U.value=[],M.value=[],V.value=[]),console.log("fetchRolesForObra - obraName:",t,"obraId:",l,"director:",o.value.director,"availableCapataces:",U.value,"availablePeones:",M.value,"availableAyudantes:",V.value)}catch(l){console.error("Error al obtener el director de la obra:",l)}},J=async()=>{h.value=!0;try{const l={obraid:d.value[o.value.obraid],tipodetarea:o.value.tipodetarea,descripcion:o.value.descripcion,fechaasignacion:o.value.fechaasignacion,fechaestimada:o.value.fechaestimada,estado:o.value.estado,activo:o.value.activo},A=(await F.post("http://desarrollo-constructora-back.onrender.com/constructora/v1/Tarea/",l)).data.tareaid;return console.log("Tarea creada con éxito, ID:",A),A}catch(t){console.error("Error al crear la tarea:",t)}finally{h.value=!1}},y=async(t,l)=>{try{const n=v.value[l];if(!n){console.error("No se encontró numerodeid para el director:",l);return}const A=await F.get("http://desarrollo-constructora-back.onrender.com/constructora/v1/DirectorDeObra/");if(!A.data||A.data.length===0){console.error("La solicitud GET para obtener directores no devolvió datos.");return}const N=A.data.find(oe=>oe.numerodeid===n);if(!N){console.error("No se encontró un director con el numerodeid especificado:",n);return}const de=N.directorid,P={tareaid:t,directorid:de};console.log("Datos de director_tarea a enviar:",P);const Q=await F.post("http://desarrollo-constructora-back.onrender.com/constructora/v1/Director_Tarea/",P);console.log("Director asignado a tarea con éxito:",Q.data)}catch(n){throw n.response?console.error("Error en la respuesta del servidor:",n.response.data):n.request?console.error("No se recibió respuesta del servidor:",n.request):console.error("Error en la configuración de la solicitud:",n.message),n}},B=async t=>{try{const l=await F.get("http://desarrollo-constructora-back.onrender.com/constructora/v1/Usuario/");if(!l.data||l.data.length===0)return console.error("La solicitud GET para obtener usuarios no devolvió datos."),null;const n=l.data.find(A=>Z(A)===t);return n?n.numerodeid:null}catch(l){return console.error(`Error al obtener numerodeid para ${t}:`,l),null}},X=async(t,l,n,A)=>{try{const N=n==="AyudanteDeObra"?"AyudanteDeObra":n,de=n==="AyudanteDeObra"?"AyudanteDeObra_Tarea":`${n}_Tarea`,P=await F.get(`http://desarrollo-constructora-back.onrender.com/constructora/v1/${N}/`);if(!P.data||P.data.length===0){console.error(`La solicitud GET para obtener ${N} no devolvió datos.`);return}for(const Q of l){const oe=await B(Q);if(!oe){console.error(`No se encontró numerodeid para el usuario: ${Q}`);continue}const ye=P.data.find(Ue=>Ue.numerodeid===oe);if(!ye){console.error(`No se encontró un ${N} con el numerodeid especificado: ${oe}`);continue}const ce=ye[`${n==="AyudanteDeObra"?"ayudanteid":`${N.toLowerCase()}id`}`],ie={tareaid:t,[`${n==="AyudanteDeObra"?"ayudanteid":`${n.toLowerCase()}id`}`]:ce};console.log(`Datos de ${de} a enviar:`,ie);const Ae=await F.post(`http://desarrollo-constructora-back.onrender.com/constructora/v1/${de}/`,ie);console.log(`${n} asignado a tarea con éxito:`,Ae.data)}}catch(N){throw N.response?console.error("Error en la respuesta del servidor:",N.response.data):N.request?console.error("No se recibió respuesta del servidor:",N.request):console.error("Error en la configuración de la solicitud:",N.message),N}},g=async()=>{if(o.value.obraid=="Selecciona Obra")D("Debe seleccionar una obra");else if(o.value.tipodetarea=="")D("Debe seleccionar un tipo de tarea");else if(o.value.descripcion=="")D("Debe darle un descripcion a la tarea");else if(o.value.estado=="")D("Debe definir el estado de la tarea");else if(o.value.fechaasignacion=="")D("Debe seleccionar una fecha de asignacion");else if(o.value.fechaestimada=="")D("Debe seleccionar una fecha estimada para la conclusion");else if(o.value.director=="")D("Debe seleccionar un director para la obra");else if(o.value.capataz.length==0)D("Debe seleccionar al menos un capataz");else if(o.value.peon.length==0)D("Debe seleccionar al menos un peon");else if(o.value.ayudante.length==0)D("Debe seleccionar al menos un ayudante");else try{const t=await J();await y(t,o.value.director),await X(t,o.value.capataz,"Capataz",K.value),await X(t,o.value.peon,"Peon",L.value),await X(t,o.value.ayudante,"AyudanteDeObra",W.value),pe.emit("tarea-create"),ne()}catch(t){console.error("Error al guardar los datos:",t)}};xe(()=>o.value.obraid,t=>{t&&t!=="Selecciona Obra"?(console.log("Seleccionada Obra:",t),p(t)):(o.value.director="Sin Director asignado",U.value=[],M.value=[],V.value=[])});const ne=()=>{o.value=structuredClone(s),U.value=[],M.value=[],V.value=[]},_e=u(""),D=t=>{const l=document.getElementById("errorItem");_e.value=t,l.style.display="block",window.scroll({top:0,left:0,behavior:"smooth"}),setTimeout(()=>{l.style.display="none"},2e3)};return De(()=>{R(),ee(),b(),T(),_()}),(t,l)=>(S(),be(Y,{justify:"center"},{default:a(()=>[e(f,{cols:"12",md:"8"},{default:a(()=>[e(le,{style:{"margin-bottom":"1vh",display:"none"},id:"errorItem"},{default:a(()=>[e(j,null,{default:a(()=>[i("form",_a,[i("p",ha,I(_e.value),1)])]),_:1})]),_:1}),e(le,{title:"Crear Tarea"},{default:a(()=>[e(j,null,{default:a(()=>[ga]),_:1}),e(ue),e(j,null,{default:a(()=>[e(ke,{ref_key:"form",ref:x,class:"mt-6"},{default:a(()=>[e(Y,null,{default:a(()=>[e(f,{cols:"12",md:"6"},{default:a(()=>[e(re,{modelValue:o.value.obraid,"onUpdate:modelValue":l[0]||(l[0]=n=>o.value.obraid=n),items:m.value,label:"ID OBRA",required:""},null,8,["modelValue","items"])]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(re,{modelValue:o.value.tipodetarea,"onUpdate:modelValue":l[1]||(l[1]=n=>o.value.tipodetarea=n),items:se,label:"Tipo de Tarea",required:"",type:"text"},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(E,{modelValue:o.value.descripcion,"onUpdate:modelValue":l[2]||(l[2]=n=>o.value.descripcion=n),label:"Descripción de la tarea",type:"text",required:""},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(re,{modelValue:o.value.estado,"onUpdate:modelValue":l[3]||(l[3]=n=>o.value.estado=n),label:"Estado",items:z,required:""},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(E,{modelValue:o.value.fechaasignacion,"onUpdate:modelValue":l[4]||(l[4]=n=>o.value.fechaasignacion=n),label:"Fecha Asignación",type:"date",required:""},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(E,{modelValue:o.value.fechaestimada,"onUpdate:modelValue":l[5]||(l[5]=n=>o.value.fechaestimada=n),label:"Fecha Estimada",type:"date",required:""},null,8,["modelValue"])]),_:1}),e(j,null,{default:a(()=>[Va]),_:1}),e(f,{cols:"12",md:"6"},{default:a(()=>[e(E,{modelValue:o.value.director,"onUpdate:modelValue":l[6]||(l[6]=n=>o.value.director=n),label:"Director de la Obra",readonly:""},null,8,["modelValue"])]),_:1}),e(ue),e(j,null,{default:a(()=>[Da]),_:1}),e(ue),e(f,{class:"cuadrilla-list"},{default:a(()=>[e(f,null,{default:a(()=>[e(Y,{justify:"center"},{default:a(()=>[e(f,{cols:"12",md:"4"},{default:a(()=>[e(re,{modelValue:o.value.capataz,"onUpdate:modelValue":l[7]||(l[7]=n=>o.value.capataz=n),label:"Capataz",items:U.value,multiple:"","menu-props":{maxHeight:500}},null,8,["modelValue","items"])]),_:1}),e(f,{cols:"12",md:"4"},{default:a(()=>[e(re,{modelValue:o.value.peon,"onUpdate:modelValue":l[8]||(l[8]=n=>o.value.peon=n),label:"Peones",items:M.value,multiple:"","menu-props":{maxHeight:500}},null,8,["modelValue","items"])]),_:1}),e(f,{cols:"12",md:"4"},{default:a(()=>[e(re,{modelValue:o.value.ayudante,"onUpdate:modelValue":l[9]||(l[9]=n=>o.value.ayudante=n),label:"Ayudantes",items:V.value,multiple:"","menu-props":{maxHeight:500}},null,8,["modelValue","items"])]),_:1})]),_:1})]),_:1})]),_:1}),e(f,{cols:"12",class:"d-flex flex-wrap gap-4 justify-end"},{default:a(()=>[e(G,{type:"submit",color:"primary",class:"mt-4",disabled:h.value,onClick:je(g,["prevent"])},{default:a(()=>[h.value?(S(),te(me,{key:0},[e(ze,{indeterminate:"",size:"20"}),w(" Guardando... ")],64)):(S(),te(me,{key:1},[w(" Guardar ")],64))]),_:1},8,["disabled","onClick"]),e(G,{color:"secondary",variant:"tonal",type:"reset",class:"mt-4",onClick:ne},{default:a(()=>[w(" Resetear ")]),_:1})]),_:1})]),_:1})]),_:1},512)]),_:1}),e(ue)]),_:1})]),_:1})]),_:1}))}},Fa={__name:"tareas-management",setup(H){const $=Ne(),O=u($.params.tab),c=[{title:"Lista de Tareas",icon:"bx-hard-hat",tab:"tareas"},{title:"Tareas archivadas",icon:"bx-archive",tab:"archived"},{title:"Crear Tarea",icon:"bx-user-pin",tab:"create"}];return(r,C)=>(S(),te("div",null,[e(Pe,{modelValue:k(O),"onUpdate:modelValue":C[0]||(C[0]=d=>Oe(O)?O.value=d:null),"show-arrows":""},{default:a(()=>[(S(),te(me,null,we(c,d=>e(qe,{key:d.icon,value:d.tab},{default:a(()=>[e(fe,{size:"20",start:"",icon:d.icon},null,8,["icon"]),w(" "+I(d.title),1)]),_:2},1032,["value"])),64))]),_:1},8,["modelValue"]),e(ue),e(Ie,{modelValue:k(O),"onUpdate:modelValue":C[1]||(C[1]=d=>Oe(O)?O.value=d:null),class:"mt-5 disable-tab-transition"},{default:a(()=>[e(Te,{value:"tareas"},{default:a(()=>[e(la)]),_:1}),e(Te,{value:"archived"},{default:a(()=>[e(ya)]),_:1}),e(Te,{value:"create"},{default:a(()=>[e(Ta)]),_:1})]),_:1},8,["modelValue"])]))}};export{Fa as default};
