const B=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],T=1,E=8;class D{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[s,n]=new Uint8Array(t,0,2);if(s!==219)throw new Error("Data does not appear to be in a KDBush format.");const i=n>>4;if(i!==T)throw new Error(`Got v${i} data when expected v${T}.`);const r=B[n&15];if(!r)throw new Error("Unrecognized array type.");const[a]=new Uint16Array(t,2,1),[o]=new Uint32Array(t,4,1);return new D(o,a,r,t)}constructor(t,s=64,n=Float64Array,i){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+s,2),65535),this.ArrayType=n,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const r=B.indexOf(this.ArrayType),a=t*2*this.ArrayType.BYTES_PER_ELEMENT,o=t*this.IndexArrayType.BYTES_PER_ELEMENT,e=(8-o%8)%8;if(r<0)throw new Error(`Unexpected typed array class: ${n}.`);i&&i instanceof ArrayBuffer?(this.data=i,this.ids=new this.IndexArrayType(this.data,E,t),this.coords=new this.ArrayType(this.data,E+o+e,t*2),this._pos=t*2,this._finished=!0):(this.data=new ArrayBuffer(E+a+o+e),this.ids=new this.IndexArrayType(this.data,E,t),this.coords=new this.ArrayType(this.data,E+o+e,t*2),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,(T<<4)+r]),new Uint16Array(this.data,2,1)[0]=s,new Uint32Array(this.data,4,1)[0]=t)}add(t,s){const n=this._pos>>1;return this.ids[n]=n,this.coords[this._pos++]=t,this.coords[this._pos++]=s,n}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return U(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,s,n,i){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:r,coords:a,nodeSize:o}=this,e=[0,r.length-1,0],c=[];for(;e.length;){const f=e.pop()||0,d=e.pop()||0,p=e.pop()||0;if(d-p<=o){for(let w=p;w<=d;w++){const x=a[2*w],M=a[2*w+1];x>=t&&x<=n&&M>=s&&M<=i&&c.push(r[w])}continue}const y=p+d>>1,u=a[2*y],A=a[2*y+1];u>=t&&u<=n&&A>=s&&A<=i&&c.push(r[y]),(f===0?t<=u:s<=A)&&(e.push(p),e.push(y-1),e.push(1-f)),(f===0?n>=u:i>=A)&&(e.push(y+1),e.push(d),e.push(1-f))}return c}within(t,s,n){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:i,coords:r,nodeSize:a}=this,o=[0,i.length-1,0],e=[],c=n*n;for(;o.length;){const f=o.pop()||0,d=o.pop()||0,p=o.pop()||0;if(d-p<=a){for(let w=p;w<=d;w++)S(r[2*w],r[2*w+1],t,s)<=c&&e.push(i[w]);continue}const y=p+d>>1,u=r[2*y],A=r[2*y+1];S(u,A,t,s)<=c&&e.push(i[y]),(f===0?t-n<=u:s-n<=A)&&(o.push(p),o.push(y-1),o.push(1-f)),(f===0?t+n>=u:s+n>=A)&&(o.push(y+1),o.push(d),o.push(1-f))}return e}}function U(h,t,s,n,i,r){if(i-n<=s)return;const a=n+i>>1;R(h,t,a,n,i,r),U(h,t,s,n,a-1,1-r),U(h,t,s,a+1,i,1-r)}function R(h,t,s,n,i,r){for(;i>n;){if(i-n>600){const c=i-n+1,f=s-n+1,d=Math.log(c),p=.5*Math.exp(2*d/3),y=.5*Math.sqrt(d*p*(c-p)/c)*(f-c/2<0?-1:1),u=Math.max(n,Math.floor(s-f*p/c+y)),A=Math.min(i,Math.floor(s+(c-f)*p/c+y));R(h,t,s,u,A,r)}const a=t[2*s+r];let o=n,e=i;for(l(h,t,n,s),t[2*i+r]>a&&l(h,t,n,i);o<e;){for(l(h,t,o,e),o++,e--;t[2*o+r]<a;)o++;for(;t[2*e+r]>a;)e--}t[2*n+r]===a?l(h,t,n,e):(e++,l(h,t,e,i)),e<=s&&(n=e+1),s<=e&&(i=e-1)}}function l(h,t,s,n){_(h,s,n),_(t,2*s,2*n),_(t,2*s+1,2*n+1)}function _(h,t,s){const n=h[t];h[t]=h[s],h[s]=n}function S(h,t,s,n){const i=h-s,r=t-n;return i*i+r*r}export{D as K};
